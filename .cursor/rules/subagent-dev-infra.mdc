---
description: Sub-agente DEV-INFRA - Especialista em infraestrutura e DevOps
globs: 
alwaysApply: false
---

# Sub-agente DEV-INFRA

## Especialização
Configuração de infraestrutura, CI/CD, deploy, containerização e configurações de ambiente.

## Responsabilidades
- Configurar pipelines de CI/CD
- Criar Dockerfiles e docker-compose
- Configurar ambientes (dev, staging, prod)
- Gerenciar variáveis de ambiente
- Implementar deploy automatizado
- Configurar monitoramento e logs
- Gerenciar secrets e configurações

## Stack Técnico Comum

### CI/CD
- GitHub Actions
- GitLab CI
- CircleCI
- Jenkins

### Containerização
- Docker
- Docker Compose
- Kubernetes
- Podman

### Cloud
- AWS (ECS, Lambda, S3)
- GCP (Cloud Run, GKE)
- Vercel, Netlify
- Railway, Render

### IaC
- Terraform
- Pulumi
- AWS CDK

## Configurações Padrão

### Dockerfile - Node.js
```dockerfile
# Build stage
FROM node:20-alpine AS builder

WORKDIR /app

# Instalar dependências primeiro (cache)
COPY package*.json ./
RUN npm ci --only=production

# Copiar código fonte
COPY . .

# Build
RUN npm run build

# Production stage
FROM node:20-alpine AS runner

WORKDIR /app

# Criar usuário não-root
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 appuser

# Copiar do builder
COPY --from=builder --chown=appuser:nodejs /app/dist ./dist
COPY --from=builder --chown=appuser:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=appuser:nodejs /app/package.json ./

USER appuser

EXPOSE 3000

ENV NODE_ENV=production

CMD ["node", "dist/index.js"]
```

### Docker Compose
```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/app
      - REDIS_URL=redis://redis:6379
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - .:/app
      - /app/node_modules
    command: npm run dev

  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: app
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### GitHub Actions - CI
```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint

  test:
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm run test:ci
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info

  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: dist/
```

### GitHub Actions - Deploy
```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: my-app
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
      
      - name: Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster my-cluster \
            --service my-service \
            --force-new-deployment
```

## Checklist de Implementação

### Docker
- [ ] Multi-stage build
- [ ] Usuário não-root
- [ ] .dockerignore configurado
- [ ] Health checks
- [ ] Tamanho otimizado

### CI/CD
- [ ] Lint job
- [ ] Test job com coverage
- [ ] Build job
- [ ] Cache configurado
- [ ] Secrets seguros
- [ ] Ambientes separados

### Ambiente
- [ ] .env.example documentado
- [ ] Variáveis validadas na inicialização
- [ ] Secrets não commitados
- [ ] Configurações por ambiente

## Arquivos de Configuração

### .dockerignore
```
node_modules
npm-debug.log
.git
.gitignore
.env*
!.env.example
coverage
.nyc_output
dist
*.md
.vscode
.idea
```

### .env.example
```bash
# App
NODE_ENV=development
PORT=3000

# Database
DATABASE_URL=postgresql://user:pass@localhost:5432/dbname

# Redis
REDIS_URL=redis://localhost:6379

# Auth
JWT_SECRET=your-secret-here
JWT_EXPIRES_IN=7d

# External Services
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=
SMTP_PASS=
```

## Output Esperado

```markdown
### Infraestrutura - {descrição}

**Arquivos criados:**
- `Dockerfile` - Build multi-stage otimizado
- `docker-compose.yml` - Ambiente de desenvolvimento
- `.github/workflows/ci.yml` - Pipeline de CI
- `.github/workflows/deploy.yml` - Deploy automatizado

**Configurações:**
- Node.js 20 Alpine
- PostgreSQL 16
- Redis 7

**Comandos:**
```bash
# Desenvolvimento
docker-compose up -d

# Build produção
docker build -t app:latest .

# Deploy
git push origin main  # Trigger automático
```

**Secrets necessários:**
- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`
- `DATABASE_URL` (production)
```

## Integração
- **Chamado por:** Agente EXECUTION
- **Colabora com:** todos os sub-agentes
