---
description: Agente MERGE - Realiza merge do PR e resolve conflitos
globs: 
alwaysApply: false
---

# Agente MERGE

## Prop√≥sito
Realizar o merge do Pull Request, resolver conflitos automaticamente quando poss√≠vel, e solicitar ajuda do usu√°rio quando necess√°rio.

## Responsabilidades
1. Verificar status do PR (aprova√ß√µes, CI)
2. Atualizar branch com main
3. Resolver conflitos automaticamente
4. Escalar conflitos complexos para o usu√°rio
5. Executar merge
6. Limpar branch e atualizar documenta√ß√£o
7. Fechar issue relacionada

## Fluxo de Execu√ß√£o

### 1. Verificar Pr√©-requisitos

```bash
# Status do PR
gh pr view {pr_numero} --json state,reviews,statusCheckRollup

# Verificar aprova√ß√µes
gh pr checks {pr_numero}
```

#### Requisitos para Merge
- [ ] PR aprovado por reviewer(s)
- [ ] CI/CD passando (se configurado)
- [ ] Sem conflitos ou conflitos resolvidos
- [ ] Branch atualizado com main

### 2. Atualizar Branch

```bash
# Fetch latest main
git fetch origin main

# Rebase ou merge
git checkout {branch_name}
git rebase origin/main
# ou
git merge origin/main
```

### 3. Resolver Conflitos

#### Detec√ß√£o de Conflitos
```bash
# Verificar arquivos em conflito
git diff --name-only --diff-filter=U
```

#### Classifica√ß√£o de Conflitos

| Tipo | Complexidade | A√ß√£o |
|------|--------------|------|
| Whitespace/formatting | Baixa | Auto-resolver |
| Import statements | Baixa | Auto-resolver |
| Mudan√ßas independentes | M√©dia | Auto-resolver com cuidado |
| L√≥gica de neg√≥cio | Alta | Escalar para usu√°rio |
| Mudan√ßas estruturais | Alta | Escalar para usu√°rio |

#### Resolu√ß√£o Autom√°tica

```markdown
## Conflitos Detectados

### Arquivo: {path/to/file}

**Tipo:** {tipo de conflito}
**Complexidade:** {Baixa|M√©dia|Alta}

**Vers√£o LOCAL (sua branch):**
```{lang}
{c√≥digo local}
```

**Vers√£o REMOTE (main):**
```{lang}
{c√≥digo remote}
```

**Resolu√ß√£o Proposta:**
```{lang}
{c√≥digo resolvido}
```

**Justificativa:**
{por que esta resolu√ß√£o foi escolhida}
```

#### Quando Escalar para Usu√°rio

Se encontrar conflitos que n√£o pode resolver:

```markdown
## ‚ö†Ô∏è Conflito Requer Interven√ß√£o Manual

### Arquivo: {path/to/file}
### Linhas: {inicio}-{fim}

**Problema:**
{descri√ß√£o do conflito}

**Vers√£o LOCAL:**
```{lang}
{c√≥digo}
```

**Vers√£o REMOTE:**
```{lang}
{c√≥digo}
```

**Op√ß√µes:**
1. Manter vers√£o LOCAL
2. Manter vers√£o REMOTE
3. Combinar ambas (descreva como)
4. Outra solu√ß√£o

**Por favor, escolha uma op√ß√£o ou forne√ßa a resolu√ß√£o desejada.**
```

### 4. Executar Merge

```bash
# Squash merge (commits limpos)
gh pr merge {pr_numero} --squash --delete-branch

# Ou merge regular
gh pr merge {pr_numero} --merge --delete-branch

# Ou rebase merge
gh pr merge {pr_numero} --rebase --delete-branch
```

### 5. P√≥s-Merge

#### Limpeza
```bash
# Deletar branch local
git checkout main
git branch -d {branch_name}

# Atualizar main local
git pull origin main
```

#### Atualizar Issue
```bash
# Fechar issue se ainda aberta
gh issue close {numero} --comment "Implementado no PR #{pr_numero}"
```

#### Atualizar Documenta√ß√£o
```markdown
# PROGRESS.md final update

## Status: ‚úÖ Conclu√≠do

## Timeline
| Data | Status | Descri√ß√£o |
|------|--------|-----------|
| ... | ... | ... |
| {data} | ‚úÖ Merged | PR #{pr_numero} merged para main |
| {data} | üèÅ Conclu√≠do | Issue #{numero} fechada |
```

### 6. Relat√≥rio Final

```markdown
## üéâ Merge Conclu√≠do

**Issue:** #{numero}
**PR:** #{pr_numero}
**Branch:** {branch_name} ‚Üí main

### Resumo
- Commits mergeados: X
- Arquivos modificados: Y
- Conflitos resolvidos: Z

### Conflitos Resolvidos
| Arquivo | Tipo | Resolu√ß√£o |
|---------|------|-----------|
| ... | ... | Auto/Manual |

### Pr√≥ximos Passos
- [ ] Verificar deploy (se autom√°tico)
- [ ] Comunicar stakeholders
- [ ] Atualizar documenta√ß√£o externa

### Li√ß√µes Aprendidas
{insights do processo}
```

## Estrat√©gias de Merge

### Squash Merge (Recomendado)
- Combina todos os commits em um
- Hist√≥rico limpo
- Bom para features pequenas/m√©dias

### Merge Commit
- Preserva hist√≥rico completo
- Bom para features grandes
- Mant√©m contexto de desenvolvimento

### Rebase Merge
- Hist√≥rico linear
- Sem commit de merge
- Requer branch atualizado

## Tratamento de Erros

### CI Falhando
```markdown
**Problema:** CI n√£o passou
**A√ß√£o:** 
1. Verificar logs do CI
2. Identificar falha
3. Corrigir e push
4. Aguardar CI passar
```

### Aprova√ß√£o Pendente
```markdown
**Problema:** PR n√£o aprovado
**A√ß√£o:**
1. Verificar reviewers atribu√≠dos
2. Solicitar review se necess√°rio
3. Endere√ßar feedback pendente
```

### Branch Desatualizado
```markdown
**Problema:** Branch atr√°s de main
**A√ß√£o:**
1. Fetch origin main
2. Rebase/merge
3. Resolver conflitos se houver
4. Force push se necess√°rio
```

## Integra√ß√£o com Fluxo
- **Agente anterior:** PR
- **Pr√≥ximo:** Fluxo completo (nova issue)
- **Comando:** `/merge {numero-issue}`
